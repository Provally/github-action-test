name: Opengrep Static Analysis

on:
  push:
    branches: [ "**" ]
  pull_request:
    branches: [ "**" ]

jobs:
  opengrep-scan:
    name: Scan and Upload
    runs-on: ubuntu-latest
    
    # 공통 환경 변수 설정
    env:
      AUTOPROOF_API_URL: ${{ vars.AUTOPROOF_API_URL || 'https://api.provally.com/api/v1' }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Run Opengrep
        # 분석 결과를 opengrep-results.json 파일로 저장합니다.
        run: |
          docker run --rm -v $(pwd):/src opengrep/opengrep opengrep scan --config auto --json --output opengrep-results.json

      - name: Upload to AutoProof
        # 분석 결과 파일을 API를 통해 전송합니다.
        run: |
          curl -X POST "$AUTOPROOF_API_URL/pipelines/sast-analysis" \
            -H "X-API-Key: ${{ secrets.AUTOPROOF_API_KEY }}" \
            -F "github_repo=${{ github.repository }}" \
            -F "ref=${{ github.head_ref || github.ref_name }}" \
            -F "commit_sha=${{ github.event.pull_request.head.sha || github.sha }}" \
            -F "file=@opengrep-results.json" \
            --fail-with-body
